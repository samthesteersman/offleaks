---
title: "Little analysis"
output: pdf_document
---

This project for Social and Economic Networks course uses Offshore Leaks Database found here <https://offshoreleaks.icij.org/>.

```{r, echo = FALSE}
# loading files
addresses <- read.csv(file = 'offshore_leaks_csvs-20160513/Addresses.csv')
edges <- read.csv(file = 'offshore_leaks_csvs-20160513/all_edges.csv')
entities <- read.csv(file = 'offshore_leaks_csvs-20160513/Entities.csv')
inters <- read.csv(file = 'offshore_leaks_csvs-20160513/Intermediaries.csv')
officers <- read.csv(file = 'offshore_leaks_csvs-20160513/Officers.csv')
```

```{r, include = FALSE}
# loading libraries
library(dplyr)
library(ggplot2)
```

## Yearly counts development

One would like to know how many accounts have been opened throughout years.

```{r, echo = FALSE}
# looking at available dates of the accounts creation
ent_incor <- entities
ent_incor$incorporation_date <- as.Date(x = as.character(ent_incor$incorporation_date), format = "%d-%b-%Y")
ent_incor <- ent_incor[!is.na(ent_incor$incorporation_date),]
ent_incor$incorporation_year <- as.numeric(format(ent_incor$incorporation_date, "%Y"))
```

The sample size for answering this question is `r nrow(ent_incor)`.

The earliest opened account belongs to `r min(ent_incor$incorporation_year)` and the latest comes from the future `r max(ent_incor$incorporation_year)`.

The most fruitful years for the offshore accounts are the following:

```{r, echo = FALSE}
head(arrange(count(ent_incor, incorporation_year), desc(n)))
```

Overall, that is how the process looks like:

```{r, echo = FALSE}
ggplot(data = ent_incor) + geom_bar(aes(x = incorporation_year)) + theme_bw()
# ggplot(data = ent_incor) + geom_line(aes(x = incorporation_year), stat = 'count') + theme_bw()
```

## CEE countries counts

Number of firms related to different Central-Eastern European countries.

```{r, echo = FALSE}
# countries <- unique(unlist(strsplit(levels(ent_incor$countries), ";")))
cee_countries <- c("Hungary", "Poland", "Romania", "Croatia",
                   "Slovenia", "Serbia", "Czech Republic", "Ukraine",
                   "Belarus", "Lithuania", "Latvia", "Estonia")
for (country in cee_countries) {
    ent_incor$new <- grepl(country, ent_incor$countries)
    names(ent_incor)[ncol(ent_incor)] <- country
}
central_europe <- ent_incor[ent_incor$Hungary | ent_incor$Poland | ent_incor$Romania | ent_incor$Croatia |
                          ent_incor$Slovenia | ent_incor$Serbia | ent_incor$`Czech Republic` |
                          ent_incor$Ukraine | ent_incor$Belarus | ent_incor$Lithuania |
                          ent_incor$Latvia | ent_incor$Estonia,]
dd <- as.matrix(central_europe[, 23:34])
central_europe$country <- factor(dd %*% 1:ncol(dd), labels = cee_countries)

table(central_europe$country)
ggplot(data = central_europe) + geom_line(aes(x = incorporation_year, color = country), stat = 'count') + theme_bw()
```

Without Latvia:

```{r, echo = FALSE}
ggplot(data = central_europe[!central_europe$Latvia,]) + geom_line(aes(x = incorporation_year, color = country), stat = 'count') + theme_bw()
```

## CEE countries relationships

It is interesting to see how are the relationships built around the entities from these countries.

```{r, echo = FALSE}
edg_cee <- edges
# selecting those links that point to or originate from CEE entities
edg_cee <- edg_cee[which(edg_cee$node_1 %in% central_europe$node_id | edg_cee$node_2 %in% central_europe$node_id),]
# getting rid of formatting in the relationship type
edg_cee$rel_type <- tolower(edg_cee$rel_type)
edg_cee$rel_type <- factor(edg_cee$rel_type)
```

There are `r nrow(edg_cee)` known links related to CEE countries entities.

The count allocation of the nodes from origin to end is the following:

```{r, echo = FALSE}
edg_cee$origin <- numeric(nrow(edg_cee))
edg_cee$origin[which(edg_cee$node_1 %in% entities$node_id)] <- "non-cee-entity"
edg_cee$origin[which(edg_cee$node_1 %in% central_europe$node_id)] <- "cee-entity"
edg_cee$origin[which(edg_cee$node_1 %in% officers$node_id)] <- "officer"   
edg_cee$origin[which(edg_cee$node_1 %in% inters$node_id)] <- "intermediary"   
edg_cee$origin[which(edg_cee$node_1 %in% addresses$node_id)] <- "address" 

edg_cee$end <- numeric(nrow(edg_cee))
edg_cee$end[which(edg_cee$node_2 %in% entities$node_id)] <- "non-cee-entity"
edg_cee$end[which(edg_cee$node_2 %in% entities$node_id)] <- "cee-entity"
edg_cee$end[which(edg_cee$node_2 %in% officers$node_id)] <- "officer"   
edg_cee$end[which(edg_cee$node_2 %in% inters$node_id)] <- "intermediary" 
edg_cee$end[which(edg_cee$node_2 %in% addresses$node_id)] <- "address"   

table(origin = edg_cee$origin, end = edg_cee$end)
```

The relationship types involved in the entities from CEE countries from origins and ends respectivelly are: 

```{r, echo = FALSE}
table(relationship = edg_cee$rel_type, origin = edg_cee$origin)
table(relationship = edg_cee$rel_type, end = edg_cee$end)
```


## Nodes decomposed

The main connections file provides `r nrow(edges)` links/edges. At both ends one can find different players.

### Origin nodes

There are `r length(unique(edges$node_1))` unique origin nodes/vertices.

```{r, echo = FALSE}
n1e <- sum(unique(edges$node_1) %in% entities$node_id)
# from all the links, 93572 entities connect to something
n1a <- sum(unique(edges$node_1) %in% addresses$node_id)
# 960
n1i <- sum(unique(edges$node_1) %in% inters$node_id)
# 23600
n1o <- sum(unique(edges$node_1) %in% officers$node_id)
# 345475
n1 <- n1e + n1a + n1i + n1o
```

They are distributed among the types in the following manner: 

Entities        |Addresses        |Intermediaries   |Officers         
----------------|-----------------|-----------------|-----------------
`r n1e`         |`r n1a`          |`r n1i`          |`r n1o`          
`r 100*n1e/n1`% |`r 100*n1a/n1`%  |`r 100*n1i/n1`%  |`r 100*n1o/n1`%  

A note. The decomposition does not sum up to the number of unique entries. `r n1` = `r length(unique(edges$node_1))` is `r n1 == length(unique(edges$node_1))`.

### Receiving nodes

Looking at the unique receiving nodes/vertices, one can find that there are `r length(unique(edges$node_2))` of them.

```{r, echo = FALSE}
n2e <- sum(unique(edges$node_2) %in% entities$node_id)
# from all the links, there 319122 connections to entities 
n2a <- sum(unique(edges$node_2) %in% addresses$node_id)
# 151043
n2i <- sum(unique(edges$node_2) %in% inters$node_id)
# 355
n2o <- sum(unique(edges$node_2) %in% officers$node_id)
# 21664
n2 <- n2e + n2a + n2i + n2o
```

They are distributed among the types in the following manner: 

Entities        |Addresses        |Intermediaries   |Officers         
----------------|-----------------|-----------------|-----------------
`r n2e`         |`r n2a`          |`r n2i`          |`r n2o`          
`r 100*n2e/n2`% |`r 100*n2a/n2`%  |`r 100*n2i/n2`%  |`r 100*n2o/n2`%  

In the same manner `r n2` = `r length(unique(edges$node_2))` is `r n2 == length(unique(edges$node_2))`.

### Origins and ends overall

The cross tabulated origins and ends from all the edges available are presented in the table below.

```{r, echo = FALSE}
edg <- edges
edg$origin <- numeric(nrow(edg))
edg$origin[which(edg$node_1 %in% officers$node_id)] <- "officer"   
edg$origin[which(edg$node_1 %in% entities$node_id)] <- "entity"   
edg$origin[which(edg$node_1 %in% inters$node_id)] <- "intermediary"   
edg$origin[which(edg$node_1 %in% addresses$node_id)] <- "address"   
edg$end <- numeric(nrow(edg))
edg$end[which(edg$node_2 %in% entities$node_id)] <- "entity"
edg$end[which(edg$node_2 %in% addresses$node_id)] <- "address"   
edg$end[which(edg$node_2 %in% officers$node_id)] <- "officer"   
edg$end[which(edg$node_2 %in% inters$node_id)] <- "intermediary"   
table(edg$origin, edg$end)
```